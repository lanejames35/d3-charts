<!DOCTYPE html>
<html lang="en-US">
	<head>
		<title>Work in progress</title>
		<meta charset="utf-8">
		<!-- Google Code Prettify Licensed under Apache 2.0 -->
		<link href="theme.min.css" rel="stylesheet">
		<link href="https://fonts.googleapis.com/css?family=Lato:400,700" rel="stylesheet"> 
		<script src="https://cdn.rawgit.com/google/code-prettify/master/loader/run_prettify.js"></script>
		<style>
		  .bar-0, .legend-0{
		    fill: #990033;
		  }
		  .bar-1, .legend-1{
		    fill: #003399;
		  }
		  .bar-2, .legend-2{
		    fill: #cc9900;
		  }
		  .whisker, .whisker-bottom, .whisker-top{
		    stroke: #000;
			stroke-width: 1.5;
			fill: none;
		  }
		  .pretty{
		    width: 1200px;
			overflow: auto;
		  }
		</style>
	</head>
	<body>
		<main class="container" role="main">
			<div class="row">
				<div class="col-xs-12">
					<h1>Durham Residents who drank alcohol in the past year</h1>
					<div id="theChart"></div>
				</div>
			</div>
			<div class="col-xs-12 col-md-6">	
				<div class="pretty">
					<h2>JS code</h2>
					<pre class="prettyprint linenums">
// set the dimensions and margins of the graph
var margin = {top: 20, right: 20, bottom: 30, left: 40},
	width = 960 - margin.left - margin.right,
	height = 500 - margin.top - margin.bottom;

// set the ranges
// x0 = outer scale for the groups (i.e. demographics)
// x1 = inner scale for the response options
var x0 = d3.scaleBand()
		  .range([0, width])
		  .padding(0.1);
var x1 = d3.scaleBand().padding(0.05);
var y = d3.scaleLinear()
		  .range([height, 0]);
		  
// append the svg object to the body of the page
// append a 'group' element to 'svg'
// moves the 'group' element to the top left margin
var svg = d3.select("#theChart").append("svg")
	.attr("width", width + margin.left + margin.right)
	.attr("height", height + margin.top + margin.bottom)
  .append("g")
	.attr("transform", 
		  "translate(" + margin.left + "," + margin.top + ")");

// get the data
// create the array "raw" to hold the input
d3.csv("alcohol2.csv").then(function(data) {
  // re-format numeric data
  data.forEach(function(d){
	d.percent = +d.percent;
	d.ucl = +d.ucl;
	d.lcl = +d.lcl;
  });	
  // Get the groups
  var groups = d3.nest()
	.key(function(d){ return d.sex; })
	.entries(data);
  console.log(groups);
  
  // Get the responses
  var res = d3.nest()
	.key(function(d) {return d.response; })
	.entries(data);
  console.log(res);
 
  // Scale for the sexes
  x0.domain( groups.map(function(d){ return d.key; }) );
  console.log(x0.domain());
  // Scale for the responses (yes/no)
  x1.domain( res.map(function(d){ return d.key; }) ).range([0, x0.bandwidth()]);
  console.log(x1.domain());
  // Scale for the outcome (percent, ucl, lcl, etc.)
  y.domain([0,100]);
  
  // append the rectangles for the bar chart
  // First, append a placeholder for each sex
  var group = svg.selectAll("g")
	  .data(groups)
	.enter().append("g")
	  .attr("transform", function(d) { return "translate(" + x0(d.key) + ",0)"; } );

  // append a bar for each response to each sex
  // for each sex-response pair, extract the numeric percentage
  var response = group.selectAll("rect")
	  .data(function(d){return d.values.map(function(j){ return {key:j.response, value:j.percent}; }); });	      
  response.enter().append("rect")
	  .attr("class", function(d, i){ return "bar-" + i; })
	  .attr("x", function(d){ return x1(d.key); })
	  .attr("width", x1.bandwidth())
	  .attr("y", function(d) { return y(d.value); })
	  .attr("height", function(d) { return height - y(d.value); });  
	  
  // draw a vertical line between UCL &amp; LCL
  // orient the line in the middle of the bar
  var vLine = group.selectAll(".verticalLines")
	  .data(function(d){return d.values.map(function(j){ return {key:j.response, whiskers:[j.lcl,j.ucl]}; }); })
	  .enter()
	  .append("line")
	  .attr("x1", function(d){ return x1(d.key) + x1.bandwidth()/2; })
	  .attr("y1", function(d){ return y(d.whiskers[0]); })
	  .attr("x2", function(d){ return x1(d.key) + x1.bandwidth()/2; })
	  .attr("y2", function(d){ return y(d.whiskers[1]); })
	  .attr("class", "whisker")
	  .attr("stroke", "#000")
	  .attr("stroke-width", 2)
	  .attr("fill", "none");
	  
  // draw two horizontal lines for the error bar "whiskers" (i.e. the hook at the top and bottom)
  var hLine1 = group.selectAll(".horizontal")
	  .data(function(d){return d.values.map(function(j){ return {key:j.response, whiskers:[j.lcl,j.ucl]}; }); })
	  .enter()
	  .append("line")
	  .attr("x1", function(d){ return x1(d.key); })
	  .attr("y1", function(d){ return y(d.whiskers[0]); })
	  .attr("x2", function(d){ return x1(d.key) + x1.bandwidth()/10; })
	  .attr("y2", function(d){ return y(d.whiskers[0]); })
	  // bump the whisker over to centre it with the vertical line
	  .attr("transform", "translate(" + x1.bandwidth()*9/20 + ",0)")
	  .attr("class", "whisker-bottom");
	  
  // Repeat with the other confidence limit
  var hLine2 = group.selectAll(".horizontal")
	  .data(function(d){return d.values.map(function(j){ return {key:j.response, whiskers:[j.lcl,j.ucl]}; }); })
	  .enter()
	  .append("line")
	  .attr("x1", function(d){ return x1(d.key); })
	  .attr("y1", function(d){ return y(d.whiskers[1]); })
	  .attr("x2", function(d){ return x1(d.key) + x1.bandwidth()/10; })
	  .attr("y2", function(d){ return y(d.whiskers[1]); })
	  .attr("transform", "translate(" + x1.bandwidth()*9/20 + ",0)")
	  .attr("class", "whisker-top");
	  
  // add the x Axis
  svg.append("g")
	  .attr("transform", "translate(0," + height + ")")
	  .call(d3.axisBottom(x0));

  // add the y Axis
  svg.append("g")
	  .call(d3.axisLeft(y));
	  
  // add the legend
  var legend = svg.append("g")
	  .attr("font-family", "sans-serif")
	  .attr("font-size", 10)
	  .attr("text-anchor", "end")
	.selectAll("g")
	.data(res.map(function(d){ return d.key }) )
	.enter().append("g")
	  .attr("transform", function(d, i) { return "translate(0," + i * 20 + ")"; });

	legend.append("rect")
	  .attr("x", width - 19)
	  .attr("width", 19)
	  .attr("height", 19)
	  .attr("class", function(d, i){ return "legend-" + i; });

	legend.append("text")
	  .attr("x", width - 24)
	  .attr("y", 9.5)
	  .attr("dy", "0.32em")
	  .text(function(d) { return d; });
	});
					</pre>
				</div>
			</div>
		</main>
		<!-- load the d3.js library -->
		<script src="https://d3js.org/d3.v5.min.js"></script>
		<script>
		// set the dimensions and margins of the graph
		var margin = {top: 20, right: 20, bottom: 30, left: 40},
			width = 960 - margin.left - margin.right,
			height = 500 - margin.top - margin.bottom;

		// set the ranges
		// x0 = outer scale for the groups (i.e. demographics)
		// x1 = inner scale for the response options
		var x0 = d3.scaleBand()
				  .range([0, width])
				  .padding(0.1);
		var x1 = d3.scaleBand().padding(0.05);
		var y = d3.scaleLinear()
				  .range([height, 0]);
				  
		// append the svg object to the body of the page
		// append a 'group' element to 'svg'
		// moves the 'group' element to the top left margin
		var svg = d3.select("#theChart").append("svg")
			.attr("width", width + margin.left + margin.right)
			.attr("height", height + margin.top + margin.bottom)
		  .append("g")
			.attr("transform", 
				  "translate(" + margin.left + "," + margin.top + ")");

		// get the data
		// create the array "raw" to hold the input
		d3.csv("alcohol2.csv").then(function(data) {
		  // re-format numeric data
		  data.forEach(function(d){
			d.percent = +d.percent;
			d.ucl = +d.ucl;
			d.lcl = +d.lcl;
		  });	
		  // Get the groups
		  var groups = d3.nest()
			.key(function(d){ return d.sex; })
			.entries(data);
		  console.log(groups);
		  
		  // Get the responses
		  var res = d3.nest()
			.key(function(d) {return d.response; })
			.entries(data);
		  console.log(res);
		 
		  // Scale for the sexes
		  x0.domain( groups.map(function(d){ return d.key; }) );
		  console.log(x0.domain());
		  // Scale for the responses (yes/no)
		  x1.domain( res.map(function(d){ return d.key; }) ).range([0, x0.bandwidth()]);
		  console.log(x1.domain());
		  // Scale for the outcome (percent, ucl, lcl, etc.)
		  y.domain([0,100]);
		  
		  // append the rectangles for the bar chart
		  // First, append a placeholder for each sex
		  var group = svg.selectAll("g")
			  .data(groups)
			.enter().append("g")
			  .attr("transform", function(d) { return "translate(" + x0(d.key) + ",0)"; } );
		
		  // append a bar for each response to each sex
		  // for each sex-response pair, extract the numeric percentage
		  var response = group.selectAll("rect")
			  .data(function(d){return d.values.map(function(j){ return {key:j.response, value:j.percent}; }); });	      
		  response.enter().append("rect")
			  .attr("class", function(d, i){ return "bar-" + i; })
			  .attr("x", function(d){ return x1(d.key); })
			  .attr("width", x1.bandwidth())
			  .attr("y", function(d) { return y(d.value); })
			  .attr("height", function(d) { return height - y(d.value); });  
			  
		   // draw a vertical line between UCL & LCL
		   // orient the line in the middle of the bar
		   var vLine = group.selectAll(".verticalLines")
			  .data(function(d){return d.values.map(function(j){ return {key:j.response, whiskers:[j.lcl,j.ucl]}; }); })
			  .enter()
			  .append("line")
			  .attr("x1", function(d){ return x1(d.key) + x1.bandwidth()/2; })
			  .attr("y1", function(d){ return y(d.whiskers[0]); })
			  .attr("x2", function(d){ return x1(d.key) + x1.bandwidth()/2; })
			  .attr("y2", function(d){ return y(d.whiskers[1]); })
			  .attr("class", "whisker")
			  .attr("stroke", "#000")
			  .attr("stroke-width", 2)
			  .attr("fill", "none");
			  
		   // draw two horizontal lines for the error bar "whiskers" (i.e. the hook at the top and bottom)
		   var hLine1 = group.selectAll(".horizontal")
			  .data(function(d){return d.values.map(function(j){ return {key:j.response, whiskers:[j.lcl,j.ucl]}; }); })
			  .enter()
			  .append("line")
			  .attr("x1", function(d){ return x1(d.key); })
			  .attr("y1", function(d){ return y(d.whiskers[0]); })
			  .attr("x2", function(d){ return x1(d.key) + x1.bandwidth()/10; })
			  .attr("y2", function(d){ return y(d.whiskers[0]); })
			  // bump the whisker over to centre it with the vertical line
   			  .attr("transform", "translate(" + x1.bandwidth()*9/20 + ",0)")
			  .attr("class", "whisker-bottom");
			  
		   // Repeat with the other confidence limit
		   var hLine2 = group.selectAll(".horizontal")
			  .data(function(d){return d.values.map(function(j){ return {key:j.response, whiskers:[j.lcl,j.ucl]}; }); })
			  .enter()
			  .append("line")
			  .attr("x1", function(d){ return x1(d.key); })
			  .attr("y1", function(d){ return y(d.whiskers[1]); })
			  .attr("x2", function(d){ return x1(d.key) + x1.bandwidth()/10; })
			  .attr("y2", function(d){ return y(d.whiskers[1]); })
   			  .attr("transform", "translate(" + x1.bandwidth()*9/20 + ",0)")
			  .attr("class", "whisker-top");
			  
		  // add the x Axis
		  svg.append("g")
			  .attr("transform", "translate(0," + height + ")")
			  .call(d3.axisBottom(x0));

		  // add the y Axis
		  svg.append("g")
			  .call(d3.axisLeft(y));
			  
		  // add the legend
			var legend = svg.append("g")
			  .attr("font-family", "sans-serif")
			  .attr("font-size", 10)
			  .attr("text-anchor", "end")
			.selectAll("g")
			.data(res.map(function(d){ return d.key }) )
			.enter().append("g")
			  .attr("transform", function(d, i) { return "translate(0," + i * 20 + ")"; });

			legend.append("rect")
			  .attr("x", width - 19)
			  .attr("width", 19)
			  .attr("height", 19)
			  .attr("class", function(d, i){ return "legend-" + i; });

			legend.append("text")
			  .attr("x", width - 24)
			  .attr("y", 9.5)
			  .attr("dy", "0.32em")
			  .text(function(d) { return d; });
			});
			
		</script>
	</body>
</html>